---
title: ElasticSearch中嵌套聚合的使用
date: 2017-09-12 13:56:29
tags:
- es
categories: "es"
---
在ElasticSearch中，通过聚合我们可以向数据提出一些更为复杂和精细的问题，这样的问题是对数据的分析和总结，而不再是寻找单个文档。<!--more-->下边首先介绍在ES中关于聚合的一些概念，随后会给出几个嵌套聚合的使用实例。
<!--more-->
##### <font size=4>基本概念</font>
***
###### <font size=3>桶</font>
桶简单来说就是满足特定条件的文档的集合，桶也可以进行嵌套，提供更为复杂和精细的划分方案。此外，ElasticSearch提供多种类型的桶，能让你通过多种方式来划分文档。
###### <font size=3>指标</font>
通过桶，我们将文档划分到了有意义的集合中，但这还不够。我们需要对桶内的文档按照某些指标进行计算。大多数指标是简单的数学运算（例如最大/最小值，平均值）。
***
**将桶和指标结合起来，就可以开始使用聚合了**。
***

##### <font size=4>应用实例</font>
***
###### <font size=3> 1 - 计算弹幕量</font>
- 计算要求：
现在需要按照房间计算每五分钟里的弹幕量，给出结果里的前一百名。根据要求，可以看出**两个聚合条件**：首先，以房间为维度进行聚合，之后嵌套聚合里按照时间进行划分，时间跨度为5分钟。
- ES查询语句：
![es-chat-query](/img/2017/09/12/es-chat-query.png)
- 查询语句解析：
- ① size设置为0，因为我们并**不关心搜索结果的具体内容**，我们关心的是聚合以后的结果。
- ② query里指定搜索的条件，这里用到了正则表达式来对弹幕内容进行过滤。
- ③ aggs（与完整形式aggregations等价）就是聚合操作，它被**置于顶层参数**之下。
> 聚合名称：xid。
> 桶的类型：terms桶。terms桶会为每个碰到的唯一词项创建新的桶。在这里我们指定了room字段，即为每个房间创建一个桶。
> 结果数量：size指定为100，返回前100条。
- ④ 接下来是一个**嵌套桶**。
> 聚合名称：times。
> 桶的类型：date_histogram桶。
>>时间间隔：interval字段代表时间间隔，这里指定为5分钟。
>>时区：将es中记录的标准时间转换为东八区时间。
>>文档数量：限制文档数量最小值，来减少返回结果的大小。
>>排序规则：按照文档数量，降序排序。
***
###### <font size=3> 2 - 计算消费总价</font>
- 计算要求：
与前一个实例要求类似，区别在于计算消费总价相当于又多了一层聚合的嵌套。
- ES查询语句：
![es-expend-query](/img/2017/09/12/es-expend-query.png)
- 查询语句解析：
- ① query里指定搜索的条件，这里用到了**前缀匹配**来对字段进行过滤。
- ② 第三层聚合利用里sum度量指标，来计算每个房间以五分钟为时间间隔的消费总价。